<div class="container">
  <p class="fs-4 fw-semibold mb-1 mt-1">Make Payment</p>
  <p class="text-muted mb-2">
    Make payment and confirm your appointment.
  </p>
  <div class="payment-section mt-4">
    <p class="fw-semibold mb-3">Payment Method</p>
    <div class="payment-options pb-2">

      <label class="radio-card">
        <input type="radio" name="paymentMode" value="insurance" [(ngModel)]="paymentMode" />
        <span>Proceed with Insurance</span>
      </label>

      <label class="radio-card">
        <input type="radio" name="paymentMode" value="cash" [(ngModel)]="paymentMode" />
        <span>Proceed with Cash</span>
      </label>

    </div>

    @if (paymentMode === 'insurance') {
    <div class="payment-box my-2">
      <p class="fw-semibold mb-2">Patient Insurance</p>
      @if (patientInsurance) {
      <div class="insurance-card mt-3">

        <div class="d-flex align-items-start gap-3">

          <div class="insurance-logo">
            <img src="insurance-logo.jpg" alt="Insurance" />
          </div>

          <div class="flex-grow-1">

            <p class="fw-semibold mb-1 insurance-name">
              {{ patientInsurance.InsuranceProviderName }}
            </p>

            <p class="text-muted mb-1">
              Policy No: {{ patientInsurance.PolicyNumber }}
            </p>

            <p class="mb-0">
              <strong>Expiry:</strong>
              {{ patientInsurance.ExpiryDate }}
            </p>

          </div>

          <div class="status-chip" [ngClass]="{
              'valid': patientInsurance.ValidationStatus === 'Valid',
              'invalid': patientInsurance.ValidationStatus !== 'Valid'
            }">
            {{ patientInsurance.ValidationStatus }}
          </div>

        </div>

      </div>

      }
      @else {
      <p class="text-muted mb-2">
        No insurance found for this patient
      </p>
      }
      <div class="py-2 px-1">
        <button (click)="openScheduleLabPopup()" class="addInsuranceBtn">
          + Add Insurance
        </button>
      </div>

    </div>
    }
    @if (paymentMode === 'cash') {
    <div class="payment-box my-2 cash-box ">
      <div class="cash-summary">

        <p class="fw-semibold mb-1">
          Pay with Cash
        </p>

        <p class="cash-amount mb-0">
          Amount:
          <span class="amount">
            OMR {{ doctorDetails.ConsultationFee }}
          </span>
          <span class="separator">•</span>
          <span class="hint">
            Pay at hospital (cash)
          </span>
        </p>

      </div>

    </div>
    }

  </div>
  <div class="summary-card p-3 p-md-4">

    <div class="row g-4">

      <div class="col-md-6 border-end">

        <p class="section-title">
          <mat-icon>medical_services</mat-icon>
          Booking Summary
        </p>

        @if (doctorDetails) {

        <div class="d-flex align-items-center gap-3 mb-3">
          <div class="doctor-img">
            @if (doctorDetails._url) {
            <img [src]="doctorDetails._url" alt="Doctor" class="rounded-circle" />
            } @else {
            <div class="fallback-img rounded-circle">
              <mat-icon>person</mat-icon>
            </div>
            }
          </div>

          <div>
            <p class="mb-0 fw-semibold">
              Dr. {{ doctorDetails.Doctor }}
            </p>
            <p class="text-muted mb-0">
              {{ doctorDetails.Designation }}
            </p>
            <p class="mb-0">
              <strong>Specialty:</strong> {{ doctorDetails.Specialty }}
            </p>
          </div>
        </div>

        <div class="info-box">
          <div class="info-row">
            <mat-icon>event</mat-icon>
            <span>
              {{ appointmentData?.selectedDate }} |
              {{ appointmentData?.selectedTime }}
            </span>
          </div>

          <div class="info-row">
            <mat-icon>payments</mat-icon>
            <span>
              {{ doctorDetails.ConsultationFee }} OMR
            </span>
          </div>
        </div>

        } @else {
        <p class="text-muted">Loading doctor details…</p>
        }

      </div>

      <div class="col-md-6">

        <div class="patient-section">

          <p class="section-title py-1">
            <mat-icon>person</mat-icon>
            Patient Details
          </p>

          @if (patientDetails) {

          <div class="d-flex align-items-center gap-3 mb-3">
            <div class="patient-avatar">
              <mat-icon>person</mat-icon>
            </div>

            <div>
              <p class="mb-0 fw-semibold">
                {{ patientDetails.Patient }}
              </p>
              <p class="text-muted mb-0">
                {{ patientDetails.Info }}
              </p>
            </div>
          </div>

          <div class="info-box mt-4">
            <div class="row g-2">

              <div class="col-12">
                <div class="info-row">
                  <mat-icon>location_on</mat-icon>
                  <span>{{ patientDetails.Address }}</span>
                </div>
              </div>

              <div class="col-6">
                <div class="info-row">
                  <mat-icon>phone</mat-icon>
                  <span>{{ patientDetails.Phone }}</span>
                </div>
              </div>

              <div class="col-6">
                <div class="info-row">
                  <mat-icon>badge</mat-icon>
                  <span>{{ patientDetails.Info }}</span>
                </div>
              </div>

            </div>
          </div>

          } @else {
          <p class="text-muted">Loading patient details…</p>
          }

        </div>
      </div>

    </div>
  </div>
  <div class="py-3">
    @if (paymentMode === 'insurance') {
    <div>
      <p>Please arrive at the reception desk 15 minutes before your appointment time to complete registration.</p>
    </div>
    }
    @if (paymentMode === 'cash') {
    <div class="confirm-payment-box ">

      <p class="fw-semibold mb-3">Payment Summary</p>

      <div class="payment-row">
        <div class="row-left">
          <mat-icon class="row-icon">medical_services</mat-icon>
          <span>Consultation Fee</span>
        </div>
        <span>OMR {{ doctorDetails.ConsultationFee }}</span>
      </div>

      <div class="payment-row">
        <div class="row-left">
          <mat-icon class="row-icon">add_circle_outline</mat-icon>
          <span>Additional Charges</span>
        </div>
        <span>OMR 5.00</span>
      </div>

      <hr class="payment-divider" />

      <div class="payment-row total">
        <span>Total Payable</span>
        <span>
          OMR {{ doctorDetails.ConsultationFee + 5 }}
        </span>
      </div>

    </div>
    }
    <div class="pt-2">
      <button (click)="bookAppointment()" [disabled]="!paymentMode" class="confirmBtn">Confirm Booking</button>
    </div>
  </div>
</div>
<app-custom-dialog [show]="showAddInsurancePopup" heading="Health Insurance"
  subheading="Add your insurance card for easy verification." [hideActions]="true" (close)="closeAddInsurancePopup()">
  <div class="upload-box mt-2" (click)="fileInput.click()">
    <input type="file" #fileInput hidden multiple accept="image/*,application/pdf" (change)="onFileSelected($event)" />
    <mat-icon class="doc-icon">description</mat-icon>
    <button matButton type="button" (click)="$event.stopPropagation(); fileInput.click()">
      <mat-icon>upload</mat-icon>
      Upload Files
    </button>
    <p class="text-muted fs-6">(File Supported : PDF, JPEG)</p>
  </div>

  <div class="mt-3">
    <p class="text-muted">Upload front & back side of your insurance card</p>

    <div class="d-flex gap-3 flex-wrap">
      <div *ngIf="fileDetails.length > 0">
        <div class="d-flex gap-3 flex-wrap">
          @for (file of fileDetails; track file) {
          <div class="preview-card">
            <img [src]="file._url" style="width:100px;height:auto;border-radius:6px" />
            <button mat-icon-button type="button" (click)="removeFile(file)">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          }
        </div>
      </div>
      <div *ngIf="uploadedPreviewUrl" class="mt-2">
        <div class="preview-card">
          <img [src]="uploadedPreviewUrl" style="width:100px;height:auto;border-radius:6px" />

          <button mat-icon-button type="button" class="small-close-btn"
            (click)="uploadedPreviewUrl=null; selectedFile=null;">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="form-col mt-4">
    <mat-form-field appearance="outline">
      <mat-label>Insurance Provider Name</mat-label>
      <input matInput required [(ngModel)]="providerName">
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Policy Number</mat-label>
      <input matInput required [(ngModel)]="policyNumber">
    </mat-form-field>
    <label>
      Expiry Date <span class="required">*</span>
    </label>
    <div class="date-row">
      <mat-form-field appearance="outline">
        <mat-label>DD</mat-label>
        <input matInput type="number" min="1" max="31" placeholder="DD" required [(ngModel)]="expiryDay" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-100">
        <mat-label>MM</mat-label>
        <mat-select [(ngModel)]="expiryMonth">
          <mat-option *ngFor="let month of months" [value]="month.value">
            {{ month.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>YYYY</mat-label>
        <input matInput type="number" min="1900" max="2100" placeholder="YYYY" required [(ngModel)]="expiryYear" />
      </mat-form-field>
    </div>

    <div class="d-flex justify-content-end gap-2">
      <button (click)="closeAddInsurancePopup()" mat-button>cancel</button>

      <button class="insuranceButton" cdkFocusInitial (click)="saveInsurance()">
        {{ isInsuranceEmpty ? 'Save Insurance' : 'Update Insurance' }}
      </button>
    </div>
  </div>
</app-custom-dialog>