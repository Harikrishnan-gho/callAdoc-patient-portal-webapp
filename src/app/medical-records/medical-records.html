<div class="container">

        <div class="loader-overlay" *ngIf="isLoadingFileUpload">
        <mat-progress-spinner
            mode="indeterminate"
            diameter="50">
        </mat-progress-spinner>
    </div>

    <div class="row">
        <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" class="border-round pb-3"
            [(selectedIndex)]="tbidx">
            <mat-tab label="Shared">
                <div class="list-container mt-3">
                    <div class="sticky-header rounded">
                        <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Search</mat-label>
                            <mat-icon matPrefix class="me-2">search</mat-icon>
                            <input matInput />
                        </mat-form-field>
                    </div>
                    <div>
                        <p class="text-muted px-2 mb-2">Shared Files</p>
                    </div>
                    <div class="no-files">
                        <mat-icon>folder_off</mat-icon>
                        <p>No medical records shared</p>
                    </div>
                </div>
            </mat-tab>
            <mat-tab label="My Uploads">
                <div class="py-2">
                    <label class="fw-semibold">
                        Upload Medical Documents
                    </label>

                    <div class="upload-box mt-2 d-flex flex-column align-items-center justify-content-center"
                        (click)="fileInput.click()">
                        <input type="file" #fileInput hidden accept="image/*,application/pdf"
                            (change)="onFileSelected($event)" />
                        <mat-icon class="doc-icon mb-2">description</mat-icon>

                        <button mat-raised-button color="primary" type="button"
                            (click)="$event.stopPropagation(); fileInput.click()">
                            <mat-icon>upload</mat-icon>
                            Upload File
                        </button>

                        <p class="text-muted fs-6 mt-2">
                            (Supported formats: PDF, JPEG, DCM)
                        </p>

                        
                        <span *ngIf="selectedFileName" class="file-name text-muted mt-1">
                            {{ selectedFileName }}
                        </span>
                    </div>

                    <!-- Upload Action Button -->
                    <div class="mt-3 text-end">
                        <button class="uploadButton" type="button" [disabled]="!selectedFile"
                            (click)="uploadMedicalRecord()">
                            Upload Medical Record
                        </button>
                    </div>
                </div>

                <div class="list-container mt-3">
                    <div class="sticky-header rounded">
                        <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Search</mat-label>
                            <mat-icon matPrefix class="me-2">search</mat-icon>
                            <input (input)="onSearchUploadedMedicalRecords($event)" matInput />
                        </mat-form-field>
                    </div>
                    <div class="medical-files">
                        <p class="text-muted px-2 mb-2">Your Uploaded Files</p>
                        @if (filteredmedicalRecords?.length > 0) {
                        @for (record of filteredmedicalRecords; track record.ID) {

                        <div (click)="openRecord(record)"
                            class="file-card d-flex align-items-center justify-content-between">

                            <!-- Left: File icon + info -->
                            <div class="d-flex align-items-center gap-3">
                                <div class="file-icon">
                                    <mat-icon *ngIf="isImage(record.FileName)">image</mat-icon>
                                    <mat-icon *ngIf="isPdf(record.FileName)">picture_as_pdf</mat-icon>
                                    <mat-icon *ngIf="isDcm(record.FileName)">monitor_heart</mat-icon>
                                    <mat-icon
                                        *ngIf="!isImage(record.FileName) && !isPdf(record.FileName) && !isDcm(record.FileName)">
                                        description
                                    </mat-icon>
                                </div>
                                <div class="file-info">
                                    <p class="file-name">{{ record.DocumentName }}</p>
                                    <p class="file-meta">
                                        {{ record.Size || '—' }} • {{ record.CreatedAt }}
                                    </p>
                                </div>

                            </div>
                            <div class="file-actions" (click)="$event.stopPropagation()">
                                <button (click)="openMedicalRecord(record)" mat-icon-button color="primary">
                                    <mat-icon>edit</mat-icon>
                                </button>
                                <button mat-icon-button color="warn" (click)="deleteRecord(record.ID)">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </div>

                        </div>
                        }
                        } @else {
                        <div class="no-files">
                            <mat-icon>folder_off</mat-icon>
                            <p>No medical records uploaded</p>
                        </div>
                        }

                    </div>

                </div>
            </mat-tab>
        </mat-tab-group>
    </div>
</div>

<app-custom-dialog [show]="showEditMedicalRecordPopup" heading="Rename File" subheading="" [hideActions]="true"
    (close)="closeMedicalRecord()">
    <div class="py-3">
        <mat-form-field appearance="outline" class="w-100">
            <mat-label>File Name</mat-label>
            <input matInput [(ngModel)]="fileName" name="fileName" required>
        </mat-form-field>
    </div>
    <div class="actions d-flex justify-end gap-3">
        <button mat-stroked-button color="warn" type="button" (click)="closeMedicalRecord()">
            Cancel
        </button>

        <button (click)="editRecord()" mat-flat-button color="primary" type="submit">
            Confirm Booking
        </button>
    </div>
</app-custom-dialog>